name: CI Pipeline - Kubernetes

on:
  push:
    branches:
      - minikube
  pull_request:
    branches:
      - main

jobs:
  validate-code:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pylint
          pip install -r app/requirements.txt

      - name: Lint code
        run: |
          pylint --disable=C0111,R0903,R0913,C0103,C0303,W0718,C0114,C0116,C0411 app/app.py

      - name: Run tests
        run: |
          pytest

  validate-kubernetes:
    runs-on: ubuntu-latest
    needs: validate-code

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Validate Kubernetes manifests
        run: |
          kubectl --dry-run=client -f manifests/configmap/postgres-configmap.yaml
          kubectl --dry-run=client -f manifests/secret/postgres-secret.yaml
          kubectl --dry-run=client -f manifests/deployment/postgres-deployment.yaml
          kubectl --dry-run=client -f manifests/service/postgres-service.yaml
          kubectl --dry-run=client -f manifests/deployment/flask-deployment.yaml
          kubectl --dry-run=client -f manifests/service/flask-service.yaml
          kubectl --dry-run=client -f manifests/autoscaling/flask-hpa.yaml
